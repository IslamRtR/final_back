const multer = require("multer") // Multer –∫—ñ—Ç–∞–ø—Ö–∞–Ω–∞—Å—ã–Ω “õ–æ—Å—É (—Ñ–∞–π–ª–¥–∞—Ä–¥—ã –∂“Ø–∫—Ç–µ—É “Ø—à—ñ–Ω)
const path = require("path") // –§–∞–π–ª –∂–æ–ª–¥–∞—Ä—ã–º–µ–Ω –∂“±–º—ã—Å —ñ—Å—Ç–µ—É “Ø—à—ñ–Ω

// üìÅ –§–∞–π–ª —Å–∞“õ—Ç–∞—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Å—ã
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, "uploads/") // –§–∞–π–ª–¥–∞—Ä–¥—ã "uploads/" –ø–∞–ø–∫–∞—Å—ã–Ω–∞ —Å–∞“õ—Ç–∞—É
  },
  filename: (req, file, cb) => {
    // –ë—ñ—Ä–µ–≥–µ–π –∞—Ç–∞—É –∂–∞—Å–∞—É: —É–∞“õ—ã—Ç –ø–µ–Ω –∫–µ–∑–¥–µ–π—Å–æ“õ —Å–∞–Ω–¥—ã “õ–æ—Å—É
    const uniqueSuffix = Date.now() + "-" + Math.round(Math.random() * 1e9)
    // –§–∞–π–ª –∞—Ç—ã: ”©—Ä—ñ—Å –∞—Ç–∞—É—ã (file.fieldname) –∂”ô–Ω–µ –±—ñ—Ä–µ–≥–µ–π —Å—É—Ñ—Ñ–∏–∫—Å
    cb(null, file.fieldname + "-" + uniqueSuffix + path.extname(file.originalname)) // –§–∞–π–ª–¥—ã“£ –∫–µ“£–µ–π—Ç—ñ–º—ñ–º–µ–Ω –±—ñ—Ä–≥–µ –∂–∞“£–∞ –∞—Ç–∞—É
  },
})

// üì∏ –§–∞–π–ª —Ñ–∏–ª—å—Ç—Ä—ñ
const fileFilter = (req, file, cb) => {
  if (file.mimetype.startsWith("image/")) { // –¢–µ–∫ —Å—É—Ä–µ—Ç —Ñ–∞–π–ª–¥–∞—Ä—ã “õ–∞–±—ã–ª–¥–∞–Ω–∞–¥—ã
    cb(null, true)
  } else {
    cb(new Error("–¢–µ–∫ —Å—É—Ä–µ—Ç —Ñ–∞–π–ª–¥–∞—Ä—ã “ì–∞–Ω–∞ “õ–∞–±—ã–ª–¥–∞–Ω–∞–¥—ã"), false) // “ö–∞—Ç–µ —Ö–∞–±–∞—Ä–ª–∞–º–∞—Å—ã
  }
}

// Multer –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Å—ã
const upload = multer({
  storage: storage, // –°–∞“õ—Ç–∞—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Å—ã
  limits: {
    fileSize: 5 * 1024 * 1024, // –ú–∞–∫—Å–∏–º—É–º —Ñ–∞–π–ª ”©–ª—à–µ–º—ñ 5MB
  },
  fileFilter: fileFilter, // –§–∞–π–ª —Ñ–∏–ª—å—Ç—Ä—ñ
})

module.exports = upload // –ú“±–Ω—ã –±–∞—Å“õ–∞ —Ñ–∞–π–ª–¥–∞—Ä–¥–∞ “õ–æ–ª–¥–∞–Ω—É “Ø—à—ñ–Ω —ç–∫—Å–ø–æ—Ä—Ç—Ç–∞—É
